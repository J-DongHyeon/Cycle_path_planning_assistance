<!DOCTYPE html>
<html lang="ko">
<meta charset="UTF-8">
<title>Cycle path planning assistance</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
	var socket = io.connect();
	var timer = null;
	$(document).ready(function(){
		socket.on("socket_up_temp", function(data){
			data = JSON.parse(data);
			$(".mqttlist_temp").html('<li>'+data.tmp+'도.'+'</li>');
		});

		if(timer==null){
			timer = window.setInterval("timer_1()", 3000);
		}
	});

	function timer_1(){
		socket.emit("socket_evt_update", JSON.stringify({}));
	}

	
	// '입력완료' 버튼 클릭 시 http server에 socket으로 출발지, 목적지와 그의 위도, 경도 정보 전송
	// 시간 정보도 전송
	var path_LatLng = []; //출발지, 목적지의 위도, 경도 정보를 담을 배열
	var markers = []; //출발지, 목적지의 마커를 담을 배열
	var polylines = []; //출발지, 목적지를 이을 선 (polyline) 을 담을 배열

	function bt_input(){
		var path_str = [];

		path_str[0] = document.getElementById('start').value;
		path_str[1] = document.getElementById('destination').value;

		socket.emit("path_str", path_str);

		var selected_item = document.getElementById("select-time");
		window.path_LatLng[0] = selected_item.options[selected_item.selectedIndex].value;
		

		geocoder.addressSearch(path_str[0], function(result, status) {

			if (status == kakao.maps.services.Status.OK) {
				window.path_LatLng[1] = result[0].y;
				window.path_LatLng[2] = result[0].x;
				
			}
		});

		geocoder.addressSearch(path_str[1], function(result, status) {

			if (status == kakao.maps.services.Status.OK) {
				window.path_LatLng[3] = result[0].y;
				window.path_LatLng[4] = result[0].x;

				socket.emit("path_LatLng", path_LatLng);

				setBounds();

				draw_line();
				
			}
		});

//		const vv = document.getElementById('bt_input');
//		vv.value = '123';


		function setBounds() {

			var points = [
				new kakao.maps.LatLng(parseFloat(path_LatLng[1]), parseFloat(path_LatLng[2])),
				new kakao.maps.LatLng(parseFloat(path_LatLng[3]), parseFloat(path_LatLng[4]))
			];

			var bounds = new kakao.maps.LatLngBounds();

			for (i=0; i<markers.length; i++) {
				markers[i].setMap(null);
			}

			var i;
			for (i=0; i<points.length; i++) {
				markers[i] = new kakao.maps.Marker({ position : points[i] });
				markers[i].setMap(map);

				bounds.extend(points[i]);
			}


			map.setBounds(bounds);
			

		}

		function draw_line() {

			if (polylines.length > 0)
				polylines[0].setMap(null);

			var linePath = [
				new kakao.maps.LatLng(parseFloat(path_LatLng[1]), parseFloat(path_LatLng[2])),
				new kakao.maps.LatLng(parseFloat(path_LatLng[3]), parseFloat(path_LatLng[4]))
			];

			polylines[0] = new kakao.maps.Polyline({
				path: linePath,
				strokeWeight: 30,
				strokeColor: '#33EE33',
				strokeOpacity: 0.5,
				strokeStyle: 'solid'
			});

			polylines[0].setMap(map);

		}

		

	}

</script>
</head>
<body>
	
	<p> 
		&emsp;&emsp;&emsp;&emsp;출발지 : <input type="text" id="start" size="20"> 
		&emsp;목적지 : <input type="text" id="destination" size="20"> 
	
		&emsp; <input type="button" id="bt_input" value="입력 완료" onclick="bt_input()" size="20">
	
		<form>
			<select id="select-time" class="select-time">
				<option value="none">=== 시간 ===</option>
				<option value="now">현재</option>
			</select>
		</form>

	</p>
	
	<script>
		var selectTime = document.querySelector('.select-time');

		var sub_option = ['3시간+', '6시간+', '9시간+', '12시간+', '15시간+', '18시간+', '21시간+', '24시간+',
		'27시간+', '30시간+', '33시간+', '36시간+', '39시간+', '42시간+', '45시간+', '48시간+', '51시간+',
		'54시간+']

		var i;
		for (i=0; i < sub_option.length; i++) {
			var option = document.createElement('option');
			option.innerText = sub_option[i];
			selectTime.append(option);
		}

	</script>

	<div id="map" style="width:1000px;height:500px;margin:auto auto;"></div>

	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a73316532a6292cb5d9a5de529289d00&libraries=services"></script>

	<script>
		var container = document.getElementById('map');
		var options = {
			center: new kakao.maps.LatLng(37.8813153, 127.7299707),
			level: 5
		};

		var map = new kakao.maps.Map(container, options);

		var geocoder = new kakao.maps.services.Geocoder();

	</script>

<!--
	<div id="msg">
		<div id="mqtt_logs">
			<ul class="mqttlist_temp"></ul>
			<ul class="mqttlist_humi"></ul>
			<ul class="mqttlist_pm"></ul>
			<button id="button1" onclick="button_on();"><b>LED ON</b></button>
			<button id="button2" onclick="button_off();"><b>LED OFF</b></button>			
		</div>
	</div>
-->

</body>
</html>

